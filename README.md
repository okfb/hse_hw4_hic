# hse_hw4_hic,

## Подготовил

Пашенцев Павел Владимирович

# Код

Весь код с комментариями доступен в [/src/main.ipynb](/src/main.ipynb).

# Выполнение

Для анализа были использованы файлы 4DNFI4HZHGLC и 4DNFIJPZ4ASS.

Эти файлы были загружены с [data.4dnucleome.org](https://data.4dnucleome.org/).

Визуализируем эти файлы при помощи HiGlass.

### Первый файл

![4DNFI3EWJW3N ](https://github.com/user-attachments/assets/897fbde6-be09-45f8-84d7-19048edf7ec7)


### Второй файл

![4DNFI79C9HVS ](https://github.com/user-attachments/assets/e5213b81-8b1c-435d-9ec9-b253be5ff8a3)


## Получение информации и атрибутов матрицы Hi-C с помощью cooler.info

С помощью cooler.info получим следующие данные:

| Атрибут             | Значение 1                                                           | Значение 2                                                           |
| ------------------- | -------------------------------------------------------------------- | -------------------------------------------------------------------- |
| **bin-size**        | 25000                                                                | 25000                                                                |
| **bin-type**        | fixed                                                                | fixed                                                                |
| **creation-date**   | 2024-12-06T03:22:01.510813                                           | 2025-01-06T11:18:38.237465                                           |
| **format**          | HDF5::Cooler                                                         | HDF5::Cooler                                                         |
| **format-url**      | [https://github.com/open2c/cooler](https://github.com/open2c/cooler) | [https://github.com/open2c/cooler](https://github.com/open2c/cooler) |
| **format-version**  | 3                                                                    | 3                                                                    |
| **generated-by**    | cooler-0.9.3                                                         | cooler-0.9.3                                                         |
| **genome-assembly** | unknown                                                              | unknown                                                              |
| **metadata**        | {}                                                                   | {}                                                                   |
| **nbins**           | 123541                                                               | 123541                                                               |
| **nchroms**         | 24                                                                   | 24                                                                   |
| **nnz**             | 215116865                                                            | 131881791                                                            |
| **storage-mode**    | symmetric-upper                                                      | symmetric-upper                                                      |
| **sum**             | 435653850                                                            | 569592662                                                            |


## Открытие объекта cooler как сбалансированной матрицу для внутрихромосомных контактов

```
m1 = clr1.matrix(as_pixels=True, balance=True).fetch(region)
```

![](/img/_1.png)

```
m2 = clr2.matrix(as_pixels=True, balance=True).fetch(region)
```

![](/img/_2.png)

## Получение таблицы с координатами и контактами, они сбалансированные или нет?

Представленные таблицы являются сбалансированными, поскольку являются нормализованными.

### Первый файл

| bin1\_id | bin2\_id | count | balanced |
| -------- | -------- | ----- | -------- |
| 51075    | 51075    | 1165  | 0.110995 |
| 51075    | 51076    | 311   | 0.031886 |
| 51075    | 51077    | 146   | 0.014928 |
| 51075    | 51078    | 127   | 0.012182 |
| 51075    | 51079    | 136   | 0.012017 |
| ...      | ...      | ...   | ...      |
| 51120    | 51121    | 87    | 0.016684 |
| 51120    | 51122    | 56    | 0.010387 |
| 51121    | 51121    | 590   | 0.102844 |
| 51121    | 51122    | 127   | 0.021413 |
| 51122    | 51122    | 615   | 0.100297 |

### Второй файл

| bin1\_id | bin2\_id | count | balanced |
| -------- | -------- | ----- | -------- |
| 52003    | 52003    | 1699  | 0.302471 |
| 52003    | 52004    | 578   | 0.099203 |
| 52003    | 52005    | 178   | 0.027472 |
| 52003    | 52006    | 103   | 0.022100 |
| 52003    | 52007    | 87    | 0.016362 |
| ...      | ...      | ...   | ...      |
| 52040    | 52041    | 556   | 0.093158 |
| 52040    | 52042    | 205   | 0.037542 |
| 52041    | 52041    | 2291  | 0.323410 |
| 52041    | 52042    | 642   | 0.099055 |
| 52042    | 52042    | 1960  | 0.330527 |


## Получение таблицу в командной строке командой *cooler dump*

```
! cooler dump -b -t pixels --header --join -r chr7:108,649,858-109,649,858 /content/drive/MyDrive/hiC/4DNFI4HZHGLC.mcool::resolutions/25000 | head
```

```
! cooler dump -b -t pixels --header --join -r chr7:108,649,858-109,649,858  /content/drive/MyDrive/hiC/4DNFIJPZ4ASS.mcool::resolutions/25000 | head
```

## Просмотр таблицы с бинами

### Вопрос: какие столбцы там присутствуют?

Присутвуют столбцы bin1, bin2, count.

### Первый файл

| bin1\_id | bin2\_id | count |
| -------- | -------- | ----- |
| 0        | 6680     | 1     |
| 0        | 42477    | 1     |
| 0        | 44196    | 1     |
| 0        | 61481    | 1     |
| 0        | 72380    | 1     |
| ...      | ...      | ...   |
| 123524   | 123525   | 202   |
| 123524   | 123526   | 18    |
| 123525   | 123525   | 361   |
| 123525   | 123526   | 22    |
| 123526   | 123526   | 93    |


### Второй файл

| bin1\_id | bin2\_id | count |
| -------- | -------- | ----- |
| 0        | 36310    | 1     |
| 0        | 48840    | 1     |
| 0        | 66705    | 1     |
| 0        | 100730   | 1     |
| 1        | 106196   | 1     |
| ...      | ...      | ...   |
| 123524   | 123525   | 560   |
| 123524   | 123526   | 33    |
| 123525   | 123525   | 1178  |
| 123525   | 123526   | 83    |
| 123526   | 123526   | 209   |


## Построение кривых зависимости число контактов от расстояния для выбранной хромосомы (в логарифмических-координатах).

Был построен следующий график:

[](/img/_log.png)

### Сравнение

- Общий тренд: у обеих кривых количество контактов убывает с увеличением - расстояния — это стандартно для Hi-C данных.
- Параллельность линий:
    - Кривые очень близки друг к другу, особенно в средней части графика.
- Это говорит о похожем распределении контактов на разных расстояниях.
- Малые расстояния:
  - При малых расстояниях (самое левое) количество контактов практически - совпадает.
- Средние расстояния:
  - Лёгкое различие появляется в районе 30-60 тысяч пар оснований.
  - Оранжевая кривая (4DNFIJPZ4ASS) чуть выше — больше контактов на этих - расстояниях.
- Большие расстояния:
  - На самых больших расстояниях (право) обе кривые резко падают.
  - 4DNFIJPZ4ASS всё ещё имеет чуть больше контактов.

### Вывод
- Оба образца имеют очень похожие профили контактов.

- 4DNFIJPZ4ASS показывает немного большее количество контактов на средних и больших расстояниях по сравнению с 4DNFI4HZHGLC.

- Различия не слишком большие, но могут указывать на:
  - разные уровни компактизации хроматина,
  - различия в клеточных линиях или условиях эксперимента.

## Нахождение insulation score и границы тадов для выбранного участка для обоих файлов 

### Первый файл 

| chrom | start    | end      | region | is\_bad\_bin | log2\_insulation\_score\_50000 | n\_valid\_pixels\_50000 | log2\_insulation\_score\_75000 | n\_valid\_pixels\_75000 | log2\_insulation\_score\_125000 | n\_valid\_pixels\_125000 | boundary\_strength\_50000 | boundary\_strength\_75000 | boundary\_strength\_125000 | is\_boundary\_50000 | is\_boundary\_75000 | is\_boundary\_125000 |
| ----- | -------- | -------- | ------ | ------------ | ------------------------------ | ----------------------- | ------------------------------ | ----------------------- | ------------------------------- | ------------------------ | ------------------------- | ------------------------- | -------------------------- | ------------------- | ------------------- | -------------------- |
| chr7  | 900000   | 925000   | chr7   | False        | 0.547676                       | 1.0                     | 0.442903                       | 6.0                     | 0.349669                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 925000   | 950000   | chr7   | False        | 0.910906                       | 1.0                     | 0.720237                       | 6.0                     | 0.468912                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 950000   | 975000   | chr7   | False        | 0.680636                       | 1.0                     | 0.794839                       | 6.0                     | 0.623563                        | 22.0                     | 0.230271                  | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 975000   | 1000000  | chr7   | False        | 0.810687                       | 1.0                     | 0.703706                       | 6.0                     | 0.705803                        | 22.0                     | NaN                       | 0.091132                  | NaN                        | False               | False               | False                |
| chr7  | 1000000  | 1025000  | chr7   | False        | 0.911849                       | 1.0                     | 0.788146                       | 6.0                     | 0.740339                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| ...   | ...      | ...      | ...    | ...          | ...                            | ...                     | ...                            | ...                     | ...                             | ...                      | ...                       | ...                       | ...                        | ...                 | ...                 | ...                  |
| chr7  | 74875000 | 74900000 | chr7   | False        | -0.253230                      | 1.0                     | -0.349859                      | 6.0                     | -0.483531                       | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74900000 | 74925000 | chr7   | False        | -0.019313                      | 1.0                     | -0.039172                      | 6.0                     | -0.315468                       | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74925000 | 74950000 | chr7   | False        | 0.300089                       | 1.0                     | -0.017531                      | 6.0                     | -0.300962                       | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74950000 | 74975000 | chr7   | False        | -0.248225                      | 1.0                     | -0.019164                      | 6.0                     | -0.268631                       | 22.0                     | 0.397335                  | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74975000 | 75000000 | chr7   | False        | -0.023618                      | 1.0                     | -0.184966                      | 6.0                     | -0.313206                       | 22.0                     | NaN                       | 0.159665                  | NaN                        | False               | False               | False                |


### Второй файл

| chrom | start    | end      | region | is\_bad\_bin | log2\_insulation\_score\_50000 | n\_valid\_pixels\_50000 | log2\_insulation\_score\_75000 | n\_valid\_pixels\_75000 | log2\_insulation\_score\_125000 | n\_valid\_pixels\_125000 | boundary\_strength\_50000 | boundary\_strength\_75000 | boundary\_strength\_125000 | is\_boundary\_50000 | is\_boundary\_75000 | is\_boundary\_125000 |
| ----- | -------- | -------- | ------ | ------------ | ------------------------------ | ----------------------- | ------------------------------ | ----------------------- | ------------------------------- | ------------------------ | ------------------------- | ------------------------- | -------------------------- | ------------------- | ------------------- | -------------------- |
| chr7  | 900000   | 925000   | chr7   | True         | NaN                            | 0.0                     | NaN                            | 0.0                     | NaN                             | 0.0                      | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 925000   | 950000   | chr7   | True         | NaN                            | 0.0                     | NaN                            | 0.0                     | NaN                             | 0.0                      | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 950000   | 975000   | chr7   | True         | NaN                            | 0.0                     | NaN                            | 0.0                     | NaN                             | 0.0                      | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 975000   | 1000000  | chr7   | True         | NaN                            | 0.0                     | NaN                            | 0.0                     | NaN                             | 0.0                      | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 1000000  | 1025000  | chr7   | False        | NaN                            | 0.0                     | NaN                            | 0.0                     | NaN                             | 0.0                      | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| ...   | ...      | ...      | ...    | ...          | ...                            | ...                     | ...                            | ...                     | ...                             | ...                      | ...                       | ...                       | ...                        | ...                 | ...                 | ...                  |
| chr7  | 74875000 | 74900000 | chr7   | False        | 0.247728                       | 1.0                     | 0.182683                       | 6.0                     | 0.299666                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74900000 | 74925000 | chr7   | False        | 0.287893                       | 1.0                     | 0.138743                       | 6.0                     | 0.240303                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74925000 | 74950000 | chr7   | False        | -0.064792                      | 1.0                     | 0.090852                       | 6.0                     | 0.185352                        | 22.0                     | 0.230099                  | 0.035894                  | NaN                        | False               | False               | False                |
| chr7  | 74950000 | 74975000 | chr7   | False        | -0.055581                      | 1.0                     | 0.106962                       | 6.0                     | 0.112550                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |
| chr7  | 74975000 | 75000000 | chr7   | False        | 0.134364                       | 1.0                     | 0.126746                       | 6.0                     | 0.101864                        | 22.0                     | NaN                       | NaN                       | NaN                        | False               | False               | False                |


## Сравнение результатов и построение графикок полученных кривых. Отобразите на них границы  ТАДов.

### Графики

Были построены графики, проведен сравнительный анализ и были сделаны выводы.

### Сравнтельный анализ

#### Insulation score

| Особенность                           | Первый график                                     | Второй график                                 |
| ------------------------------------- | ------------------------------------------------- | --------------------------------------------- |
| **Яркость карты**                     | Более яркая (контактов больше).                   | Более тусклая (контактов меньше).             |
| **Диапазон интенсивностей**           | Ярче, теплее (интенсивные контакты).              | Слабее выражены зоны высокой плотности.       |
| **Изоляционный скор (инсулейшн)**     | Варьируется от примерно -0.6 до +0.6.             | Меньше вариация, от -0.8 до +0.2.             |
| **Сильные границы** (оранжевые точки) | Много, равномерно по оси X.                       | Меньше, 2–3 сильные границы.                  |
| **Общее число границ**                | Больше слабых и сильных границ.                   | Меньше границ вообще.                         |
| **Шум в insulation score**            | Больше флуктуаций вверх-вниз (более резкие пики). | Более сглаженная кривая без резких изменений. |

#### Выводы
Первый график показывает более сложную и детализированную структуру доменов:
- Больше плотных контактов.
- Выраженные сильные границы.
- Высокая вариабельность insulation score — наводит на мысль о большем числе TAD-ов.
Второй график:
- Меньшая плотность контактов, более равномерное распределение.
- Меньше выделенных границ, слабее структура TAD-ов.
- Кривая insulation score менее "зубчатая", сглаженная.

Итого: первый образец имеет более четкую топологическую организацию хроматина по сравнению со вторым.

#### Файл 1

![](/img/_1_ins.png)

#### Файл 2

![](/img/_2_ins.png)


#### Границы

| Особенность                        | Первый график (\_1\_bound.png)               | Второй график (\_2\_bound.png)                |
| ---------------------------------- | -------------------------------------------- | --------------------------------------------- |
| **Window 50 kb**                   | 6771 (Otsu), 12315 (Li) границ               | 6767 (Otsu), 10137 (Li) границ                |
| **Window 75 kb**                   | 3131 (Otsu), 6201 (Li) границ                | 5390 (Otsu), 8068 (Li) границ                 |
| **Window 125 kb**                  | 2606 (Otsu), 4565 (Li) границ                | 4494 (Otsu), 6388 (Li) границ                 |
| **Пик распределения силы границы** | Левее, пик при меньших значениях (\~0.1-0.3) | Правее, пик при больших значениях (\~0.3-0.7) |
| **Форма распределения**            | Более широкий, плавный пик                   | Более резкий пик, затем быстрое падение       |
| **Количество границ**              | **Больше слабых границ** (низкий порог Li)   | **Меньше слабых границ**, более строгий отбор |
| **Порог Otsu**                     | Розовая линия левее (меньше сила границы)    | Розовая линия правее (больше сила границы)    |
| **Порог Li**                       | Зелёная линия левее                          | Зелёная линия правее                          |

#### Выводы 

Первый график (левый):
- Больше слабых границ (особенно по методу Li).
- Пик распределения находится на меньших значениях силы границы.
- В целом большее количество мелких, слабых TAD-границ.

Второй график (правый):
- Меньше границ, но они сильнее.
- Распределение смещено вправо — границы имеют большую силу.
- Более строгий порог Otsu и Li → больше сильных границ, меньше слабых.

Итого:
- Первый образец отражает более мелкую и детализированную структуру TAD-ов, с множеством слабых границ.
- Второй образец демонстрирует меньшее количество, но более сильных и - отчётливых границ, возможно, более стабильную организацию хроматина.

#### Файл 1

![](/img/_1_bound.png)

#### Файл 2

![](/img/_2_bound.png)

## Создание 2 bed файла с границами ТАДов.В поле score добавьте силу границы.

Оба файла находятся в папке [tads](/tads/).

### Часть файла 1

| Chromosome | Start     | End       | Score\_1             | Pixels\_1 | Score\_2              | Pixels\_2 | Boundary Strength 1  | Boundary Strength 2  | Boundary Strength 3 | is\_boundary\_1 | is\_boundary\_2 |
| ---------- | --------- | --------- | -------------------- | --------- | --------------------- | --------- | -------------------- | -------------------- | ------------------- | --------------- | --------------- |
| chr7       | 108625000 | 108650000 | -0.7145674309794952  | 6.0       | -1.0159981352575946   | 22.0      | 0.044394147193557054 |                      |                     | False           | False           |
| chr7       | 108700000 | 108725000 | -0.27433260736102666 | 6.0       | -0.4824480049026862   | 22.0      | 0.17202500253409875  |                      |                     | False           | False           |
| chr7       | 108775000 | 108800000 | -0.08466864741787185 | 6.0       | -0.21342151322912267  | 22.0      | 0.23282918354785093  |                      |                     | False           | False           |
| chr7       | 108875000 | 108900000 | 0.015522451342922973 | 6.0       | -0.060379196120428316 | 22.0      | 0.07056240282572335  | 0.009416981162616503 |                     | False           | False           |
| chr7       | 108925000 | 108950000 | -0.08396622141163315 | 6.0       | -0.06182709523129337  | 22.0      | 0.4889425937655842   |                      |                     | False           | False           |
| chr7       | 109050000 | 109075000 | 0.1302872249704534   | 6.0       | 0.07164254215336863   | 22.0      | 0.4858939259408938   | 0.08854335261968757  | 0.07210752475649213 | False           | False           |


### Часть файла 2

| Chromosome | Start     | End       | Score\_1             | Pixels\_1 | Score\_2             | Pixels\_2 | Boundary Strength 1 | Boundary Strength 2 | Boundary Strength 3 | is\_boundary\_1 | is\_boundary\_2 |
| ---------- | --------- | --------- | -------------------- | --------- | -------------------- | --------- | ------------------- | ------------------- | ------------------- | --------------- | --------------- |
| chr7       | 108775000 | 108800000 | -0.03146871904448465 | 6.0       | 0.03258772952282854  | 22.0      | 0.33601561159812104 | 0.09069546494930475 |                     | False           | False           |
| chr7       | 108900000 | 108925000 | -0.19821172465304618 | 6.0       | -0.25381303617242246 | 22.0      | 0.08514509511192142 |                     |                     | False           | False           |
| chr7       | 108950000 | 108975000 | -0.43623152576818336 | 6.0       | -0.4460131218888676  | 22.0      | 0.535466038154977   | 0.41603940528311134 | 0.4028959554257442  | True            | True            |
| chr7       | 109075000 | 109100000 | -0.09565378388348453 | 6.0       | -0.07595276198560558 | 22.0      | 0.0903357572300291  |                     |                     | False           | False           |
| chr7       | 109125000 | 109150000 | -0.06561655823815585 | 6.0       | -0.08194262612978244 | 22.0      | 0.26308863486946227 |                     |                     | False           | False           |
| chr7       | 109175000 | 109200000 | -0.09733284169690973 | 6.0       | -0.0732370209139087  | 22.0      | 0.0409826204598981  |                     |                     | False           | False           |
